
## 1. 概念

### 1.1. TCP/IP协议簇的四个层次

链路层-网络层-运输层-应用层

每一层负责不通的功能：

1. 链路层：也被称为数据链路层或网络接口层，通常包括操作系统中设备驱动程序和计算机对应的网络接口卡，他们一起处理与电缆（或其他传输媒介）的物理接口细节

2. 网络层：有时也称作互联网层，处理分组在网络中的活动，例如分组的选路。在TCP/IP协议簇中，网络层包含IP协议，ICMP协议（Internet互联网通知报文协议），IGMP协议（Internet组管理协议）

3. 运输层：主要为两台主机上的应用程序提供端到端的通信。在TCP/IP协议簇中，有两个互不相同的传输协议：TCP（传输控制协议）和UDP（用户数据报协议）。

   - **TCP全称是传输控制协议，是面向连接的协议，为两台主机提供高可靠的数据通信。在收发数据之前，必须和对方建立可靠的连接，通过三次握手建立连接，四次挥手关闭连接。它所做的工作把应用程序交给它的数据分成合适的小块交给下面的网络层，确认接收到的分组，设置发送最后确认分组超时时钟等。使用TCP协议传输的服务包括FTP、HTTP、TELNET等**。
   - **UDP全称是用户数据报协议，在网络中与TCP一样工作在第四层运输层，用于处理数据包。是一种无连接的协议，不提供数据包分组、组装和不能对数据包进行排序，也就是说，当报文发送之后，是无法得知其是否安全完整到达的。UDP的信息包标题很短，只有8个字节，相对于TCP的20字节信息包的开销要小很多。使用UDP协议传输的服务包括DNS、NFS、DHCP等**

   这两种传输层协议分别在不通应用程序中有不同的用途。

4. 应用层：负责处理特定的应用程序细节。几乎各种不同的TCP/IP 实现都会提供下面这些通用的应用程序：

   - Telnet远程登录
   - FTP文件传输写意思
   - SMTP简单邮件传输协议
   - SNMP简单网络管理协议

应用层层序通常是一个用户进程，下三层一半在操作系统内核中执行。应用层与其他三层还有另一个关键的不同之处，应用层关心的是应用程序的细节，而不是数据在网络中的传输活动。下三层对应用程序一无所知，但他们要处理所有的通信细节。

例如：FTP是应用层协议，TCP是一种运输层协议，IP是一种网络层协议，以太网协议是链路层协议。**TCP/IP协议簇是一组不同的协议组合在一起构成的协议簇**。尽管通常称该协议簇为TCP/IP，但是TCP和IP只是其中两种协议而已（该协议簇的另一个名称是Internet协议簇（Internet Protocol Suite））。

### 1.2. 运输层和网络层的区别

**在TCP/IP 协议簇中，网络层IP提供的是不可靠的服务。也就是说，它只是尽可能快的把分组从源结点送到目的结点，但是并不提供任何可靠性保证。另一方面，TCP在不可靠的IP层上采用了超时重传、发送和接收端到端的确认分组机制来提供了一个可靠的传输层**。由此可见，运输层和网络层分别负责不同的功能。

### 1.3. 封装

当应用程序用TCP传输数据时，数据被送入协议栈中，然后逐个通过每一层直到被当做一串比特流送入网络。其中每一层对收到的数据都要增加一些首部信息（有时还要增加尾部信息）

![头部封装过程](images/tcpip_baowenfengzhuang.jpg)

**TCP传给IP的数据单元称作TCP报文段或简称为TCP段(TCP segment)。IP传给网络接口层的数据单元称作IP数据报(IP datagram)。通过以太 网传输的比特流称作帧(Frame)。UDP数据与TCP数据基本一致。唯一不同的是UDP传给IP的信息单元称作UDP数据报，而且UDP的首部长度为8字节**。许多应用程序都可以使用UDP或TCP来传输数据。运输层协议在生成报文首部时要存入一个应用程序的标识符。TCP或UDP都用一个16bit的端口号来表示不同的应用程序。TCP和UDP把源端口号和目标端口号分别存入报文首部中。 

Unix系统有保留端口号的概念，只有具有超级用户特权的进程才允许给它自己分配一个保留端口号。这些端口号介于1-1023之间，一些应用程序将它作呕为客户与服务器直接身份认证的一部分。

##  2. 链路层

在TCP/IP协议簇中，链路层有三个主要目的：

1. 为IP模块发送和接收ip数据报
2. 为ARP模块发送APP请求和接收ARP应答
3. 为RARP模块发送RARP请求和接收RARP应答

### 2.1. 路径MTU

最大传输单元MUT。网络中两台主机之间通信，经过的网络链路层可能有多种不同的MTU，重要的是两台通信主机路径中最小MTU。它被称作路径MTU。

两台主机之间的路径MTU不是一个常数。它取决于当时所选择的陆游与。而选路不一定是对称的（从A到B的路由可能与从B到A不同），因此路径MTU在两个方向上不一定是一致的。

#### 大包问题：

使用Ping命令模拟大包传输结合wireshark进行抓包分析，通过ping 百度地址来进行测试

```shell
$ ping www.baidu.com
PING www.a.shifen.com (61.135.169.121): 56 data bytes
64 bytes from 61.135.169.121: icmp_seq=0 ttl=57 time=3.590 ms
64 bytes from 61.135.169.121: icmp_seq=1 ttl=57 time=4.581 ms
```

可以正常获取返回值，抓包分析

![抓包分析1](/images/posts/wireshark-ping001.png)

使用ping的-s参数指定包体长度。由于 MTU 是整个 IP 包的最大长度，那么 ICMP 包的最大 payload 就是 MTU - 20 (IP header) - 8 (ICMP header)，因此能 ping 通且不分片的最大参数值是 MTU - 28。标准 MTU 为 1500bytes，那么 ping 命令的长度参数最大可指定为 1472bytes

```shell
$ ping www.baidu.com -s 1472
PING www.a.shifen.com (220.181.38.149) 1472(1500) bytes of data.
1480 bytes from 220.181.38.149: icmp_seq=1 ttl=53 time=3.41 ms
1480 bytes from 220.181.38.149: icmp_seq=2 ttl=53 time=3.44 ms
1480 bytes from 220.181.38.149: icmp_seq=3 ttl=53 time=3.44 ms
1480 bytes from 220.181.38.149: icmp_seq=4 ttl=53 time=3.44 ms
```

![抓包分析1](/images/posts/wireshark-ping002.png)

那么当指定包体长度超过1472，就会发现包无法发送出去。

分片会加重路由器的负担，因此只要条件允许，我们都不希望路由器对IP数据包进行分片处理。另外，如果一个分片丢失，整个IP数据报都会作废，因为网络层没有重传机制，只能由上层协议实现。

解决以上问题的技术是“路径MTU发现”。主机会首先获取整个路径中所有数据链路的最小MTU，并按照整个大小将数据分片。因此传输过程中的任何一个路由器都不用进行分片工作。

为了找到路径MTU，主机首先发送整个数据包，通过抓包分析IP层将数据分段（frag）传输过程中，前两次通过将DF标志位（Don't Fragment）设置为1，这样路由器在遇到需要分片的数据时不会执行分片操作，而是丢弃数据报，然后通过ICMP协议将整个不可达的信息返回，主机将返回的MTU值设置为当前的MTU，根据这个MTU进行分片后再次发包出去，循环执行前一次的操作调整自身的MTU值直到不再接收到ICMP的通知为止，此时的MTU就是路径最小MTU，IP层开始按照这个MTU进行分片传输，并且将DF值设置为0。每30s将DF设置为1，以查看路径MTU是否增大了。

## 3. IP：网际协议

IP是TCP/IP协议簇中最为核心的协议。所有的TCP、UDP、ICMP以及IGMP数据都以IP数据报格式传输。IP协议有以下特性：

1. 不可靠，它不能保证IP数据报能成功的到达目的地。IP仅提供最好的传输服务。如果发生某种错误时，如果某个路由器暂时用完了缓冲区，IP有一个简单那的错误处理算法：丢弃该数据报，然后发送ICMP消息给信源端。任何要求的可靠性必须由上层提供（例如TCP）
2. 无连接，IP协议并不维护任何关于后续数据报的状态信息。每个数据报的处理是相互独立的。这说明，IP数据报可以不按发送顺序接收。如果以信源向相同的信宿发送两个连续的数据报（先发送A，后发送B），每个数据报都是独立的进行路由选择，可能选择不同的路线，因此B可能比A线到达。

### 3.1. IP首部

普通IP首部长度为20字节，除非含有选项字段

![ip数据格式](./images/ip_shujubaowen.jpeg)

## 4. ARP: 地址解析协议

当一台主机把以太网数据发送到位于同一局域网上的另一台主机时，是根据48bit的以太网地址来确定目的地址。

ARP为 IP地址到对应的硬件地址之间提供动态映射。我们之所以用动态这个词是因为这个过程是自动完成的，一般应用程序用户或系统管理员不必关心。

RARP是被那些没有磁盘驱动器的系统使用（一般是无盘或工作站或X终端），它需要系统管理员手动设置。

### 4.1. ARP高速缓存超时设置

在ARP高速缓存的表项一般都要设置超市实战，从伯克利系统演变而来的系统跟一般对完整表项设置超时值为20分钟，而对不完整表项设置超时值位3分钟。当这些表项再次使用时，这些实现一般都把超时值重新设为20分钟。

### 4.2. ARP代理

**如果ARP请求是从一个网络的主机发往另一个网络上的主机，那么连接这两个网络的路由器就可以回答请求，这个过程称作委托ARP或ARP代理**。这样可以欺骗发起ARP请求的发送端，是它误以为路由器就是目的主机，而事实上目的主机在路由器的另一边。

## 5. RARP：逆地址解析协议

具有本地磁盘的系统引导时，一般是从磁盘上的配置文件读取IP地址。但是无盘机则需要采用其他方法获得IP地址。网络上每个系统都具有唯一的硬件地址，它是由接口厂家配置的。无盘系统的RARP实现过程是从接口卡上读取唯一的硬件地址，然后发送一份RARP请求（一帧在网络上广播的数据），请求某个主机响应该无盘系统的IP地址。

##　６. ICMP： Internet控制报文协议

ICMP经常被认为是 IP层的一个组成部分。它传递差错报文以及其他需要注意的信息。ICMP报文通常被IP层或更高层（TCP或UDP）使用。一些icmp报文把差错报文返回给用户进程。

ICMP报文是在IP数据内部被传输的

| IP首部（20字节）| ICMP报文|

### 报文类型

不会导致差错报文的情况：

1. ICMP差错报文（但是，ICMP查询报文可能会产生差错报文）
2. 目的地址是广播地址或多播地址的IP数据报
3. 作为链路层广播的数据报
4. 不作为IP分配的第一片
5. 原地址不是单个主机的数据报。这就是说源地址不能为零地址、环回地址、广播或多播地址

### Ping

发送回显请求的ping程序为客户，而称被ping的主机为服务器。大多数TCP/IP实现都在内核中直接支持Ping服务器（这是一种服务器而不是一个用户进程）。

Ping程序通过在ICMP报文数据中存放发送请求的时间值来计算往返时间。当应答返回时，用当前时间减去存放在ICMP报文中的时间值，既往返时间。

### TraceRoute

IP源站选路选项：

- 宽松的源站选路。发送端指明了数据报经过的IP地址清单，但是数据报在清单上知名的任意两个地址之间可以通过其他路由器
- 严格的源站路由选择。发送端指明IP数据报所采用的确切路由。如果偶一个路由发现源路由地址的下一跳路由不在其直接连接的网络上，那么它就返回一个“源站路由失败”的ICMP差错报文。

源站陆游与选项的实际称呼为“源站及记录路由”，这是因为数据报在路由发送过程中，对IP地址清单进行了更新，下面是运行你过程：

1. 发送你主机应用程序接受源站路由清单，将第一个表项去掉（它是数据报的最终目的地址），将剩余的项移动到第一个项中，并将原来的目的地址作为清单的最后一项。指针仍然指向清单的第一项
2. 每个处理数据报的路由检查其是否为数据报的最终地址。如果不是，则正常转发数据报（在这种情况下必须指明宽松路由，否则就不能接收到该数据报）。
3. 如果该路由器是最终目的，且指针不大于路径长度，那么（1）有ptr所指定的清单中的下一个地址就是数据报的最终地址；（2）由外出接口相对应的IP地址取代刚才使用的源地址；（3）指针加4；？？？？？？？

## 7. IP选路

使用netstat命令显示路由表

```sh
# netstat -rn
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         10.40.11.253    0.0.0.0         UG        0 0          0 eth0
10.40.8.0       0.0.0.0         255.255.252.0   U         0 0          0 eth0
192.168.177.0   0.0.0.0         255.255.255.0   U         0 0          0 docker0
192.168.178.0   0.0.0.0         255.255.255.0   U         0 0          0 br-1e0a10ee86cf
192.168.179.0   0.0.0.0         255.255.255.0   U         0 0          0 br-d3b067fb8885
192.168.180.0   0.0.0.0         255.255.255.0   U         0 0          0 br-25bafbfffd08
```

第4行说明目标日志如果是0.0.0.0（任意地址），那么网关（路由器）将把分组转发给10.40.11.253 。

对于一个给定路由器，可以打印出5中不同标志flag：

1. U 该路由可用
2. G 该路由到一个网关路由器。如果没有该标志，说明目的是直接相连的
3. H 该路由到一个主机，也就是说目的地址是一个完整的主机地址。如果没有该标志，说明该路由是到一个网络，而目的地址是一个网络地址：一个网络号，或者网络号与子网的组合
4. D 该路由是重定向报文创建的
5. M 该路由已被重定向报文修改

标志G是非常重要的，因为由它区分了间接路由和直接路由(对于直接路由来说是不设置标志G的)。其区别在于：发往直接路由的分组中不但具有指明目的端的IP地址，还具有其链路层MAC地址。当分组被发往一个间接路由时，IP地址指明的是最终的目的地，但是链路层MAC地址指明的是网关(即下一站路由器)。

## 8. UDP协议

### 8.1. UDP首部

| 0-15         | 16-31          |
| ------------ | -------------- |
| 16位源端口号 | 16位目的端口号 |
| 16位UDP长度  | 16位UDP校验和  |
| 数据         |                |

端口号表示发送进程和接收进程。TCP和UDP用目的端口号来分用来自IP层的数据的过程。由于IP层已经把IP数据分配给TCP和UDP（根据IP首部的协议字段值），因此TCP端口号有TCP查看，UDP端口号由UDP查看，是相互独立的。

## 9. TCP传输控制协议

### 9.1. 可靠性方式

1. 引用数据被分割成TCP认为最适合发送的数据块。和UDP不同，应用程序产生的数据报长度将保持不变。由TCP传递给IP的信息单位称为报文段或段（segment）。
2. 当TCP发送一个段的时候，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到确认，将重发这个报文段。
3. 当TCP收到发自TCP连接另一端的数据，它将发送确认。这个确认不是立即发送，通常推迟几分之一秒
4. TCP将保持它首部和数据校验和。这是一个端到端的校验和，目的是检测数据在传输过程中的任何变化，。如果收到的校验和由差错，TCP将丢弃这个报文段和不确认收到此报文段（希望发送端超时并重发）。
5. 既然TCP报文段作为IP数据来传输，而IP数据报的到达可能会失序，因此TCP报文段的到达也可能会失序。如果必要，TCP将对收到的数据进行重新排序，将收到的数据以正确的属性交给应用层。
6. 既然IP数据报会发生重复，TCP的接收端必须丢弃重复的数据。
7. TCP还能提供流量控制。TCP连接的每一方都有固定大小的缓冲空间。TCP的接收端只能允许另一端发送接收端缓冲区所能接纳的数据。这将防止较快主机致使较慢主机的缓冲区溢出。

### 9.2. TCP报文

TCP首部有20字节，首部数据的格式为

![tcp](/images/posts/tcp-header-type.png)

- URG： 紧急指针（urgent pointer）有效
- ACK： 确认序号有效
- PSH：接收方应尽快将这个报文段交给应用层
- RST：重建连接
- SYN：同步序号用来发起一个链接
- FIN：发送端完成发送任务

TDP 的流量控制由**连接的每一端通过声明的窗口大小来提供**。窗口大小为字节数，起始于确认序号字段指明的值，这个值是接收端正期望接收的字节。窗口大小是一个16bit字段，因而窗口大小为65536字节。数据报文中的win4096表示发端通告的窗口大小。

最常见的可选字段是最长报文大小，又称为MSS（Maximum Segment Size）。每个链接方通常在通信的第一个报文段（为建立连接而设置SYN标志的那个端）中指明选项，MSS只能出现在SYN报文段中。它指明本端所能接收的最大长度的报文段。数据报文中mss1024表示发由送端指明的最大报文段长度，发端不接收超过这个长度的TCP报文段。当TCP发送一个SYN时，或者是因为一个本地应用进程想发起一个连接，或者是因为另一端的主机收到了一个连接请求，它能将MSS值设置为外出接口上的 MTU长度减去固定的IP首部和TCP首部长度。对于一个以太网，MSS值可达1460字节（1500字节 - 20字节tcp首部 - 20字节ip首部）。使用IEEE 802.3的封装(参见2.2节)，它的MSS可达1452字节。如果建立连接的两方声明的MSS值不等，将以最小值进行传输。

如果两端的主机都连接到以太网上，都采用536的MSS，但中间网络采用296的MTU， 也将会出现分段。使用路径上的MTU发现机制是关于这个问题的唯一方法。

### TCP 连接的建立与终止

TCP是一个面向连接的协议。无论哪一方向向另一方发送数据之前，都必须在双方之间建立一条连接。

